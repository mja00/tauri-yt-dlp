name: Build

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]
    workflow_dispatch:

permissions:
    contents: write
    packages: write

jobs:
    build:
        strategy:
            fail-fast: false
            matrix:
                include:
                    - platform: "windows-latest"
                      target: "x86_64-pc-windows-msvc"
                      os: "windows"
                    - platform: "macos-latest"
                      target: "aarch64-apple-darwin"
                      os: "macos"
                      args: "--target aarch64-apple-darwin"
                    - platform: "macos-latest"
                      target: "x86_64-apple-darwin"
                      os: "macos-intel"
                      args: "--target x86_64-apple-darwin"
                    - platform: "ubuntu-latest"
                      target: "x86_64-unknown-linux-gnu"
                      os: "linux"
                      args: "--target x86_64-unknown-linux-gnu"

        runs-on: ${{ matrix.platform }}

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Install dependencies (Ubuntu)
              if: matrix.os == 'linux'
              run: |
                  sudo apt-get update
                  sudo apt-get install -y libwebkit2gtk-4.1-dev \
                    build-essential \
                    curl \
                    wget \
                    file \
                    libssl-dev \
                    libgtk-3-dev \
                    libayatana-appindicator3-dev \
                    librsvg2-dev

            - name: Install jq (Unix)
              if: matrix.os != 'windows'
              run: |
                  if [ "${{ runner.os }}" == "Linux" ]; then
                    sudo apt-get update && sudo apt-get install -y jq
                  elif [ "${{ runner.os }}" == "macOS" ]; then
                    if ! command -v jq &> /dev/null; then
                      brew install jq
                    fi
                  fi

            - name: Ensure all scripts are executable
              if: matrix.os != 'windows'
              run: chmod +x scripts/*.sh

            - name: Download YT-DLP binaries
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: bash ./scripts/download-ytdlp.sh

            - name: Make binaries executable (Unix)
              if: matrix.os != 'windows'
              run: |
                  chmod +x src-tauri/resources/yt-dlp_* || true

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"
                  
            - name: install Rust stable
              uses: dtolnay/rust-toolchain@stable
              with:
                targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

            - name: Install frontend dependencies
              run: npm ci

            - name: Build the app with Tauri
              uses: tauri-apps/tauri-action@v0.6.0
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  tagName: app-v__VERSION__
                  projectPath: ./src-tauri
                  args: ${{ matrix.args }}
                  releaseName: 'YT DLP GUI v__VERSION__'
                  releaseBody: 'See the assets to download'
                  releaseDraft: true
                  prerelease: false
