name: Build

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]
    workflow_dispatch:

jobs:
    build:
        strategy:
            fail-fast: false
            matrix:
                include:
                    - platform: "windows-latest"
                      target: "x86_64-pc-windows-msvc"
                      os: "windows"
                    - platform: "macos-latest"
                      target: "aarch64-apple-darwin"
                      os: "macos"
                    - platform: "macos-latest"
                      target: "x86_64-apple-darwin"
                      os: "macos-intel"
                    - platform: "ubuntu-latest"
                      target: "x86_64-unknown-linux-gnu"
                      os: "linux"

        runs-on: ${{ matrix.platform }}

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Install dependencies (Ubuntu)
              if: matrix.os == 'linux'
              run: |
                  sudo apt-get update
                  sudo apt-get install -y libwebkit2gtk-4.1-dev \
                    build-essential \
                    curl \
                    wget \
                    file \
                    libssl-dev \
                    libgtk-3-dev \
                    libayatana-appindicator3-dev \
                    librsvg2-dev

            - name: Install Rust
              uses: dtolnay/rust-toolchain@stable
              with:
                  targets: ${{ matrix.target }}

            - name: Rust cache
              uses: swatinem/rust-cache@v2
              with:
                  workspaces: "./src-tauri -> target"

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"

            - name: Install frontend dependencies
              run: npm ci

            - name: Install jq (Unix)
              if: matrix.os != 'windows'
              run: |
                  if [ "${{ runner.os }}" == "Linux" ]; then
                    sudo apt-get update && sudo apt-get install -y jq
                  elif [ "${{ runner.os }}" == "macOS" ]; then
                    if ! command -v jq &> /dev/null; then
                      brew install jq
                    fi
                  fi

            - name: Ensure all scripts are executable
              if: matrix.os != 'windows'
              run: chmod +x scripts/*.sh

            - name: Download YT-DLP binaries
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: bash ./scripts/download-ytdlp.sh

            - name: Make binaries executable (Unix)
              if: matrix.os != 'windows'
              run: |
                  chmod +x src-tauri/resources/yt-dlp_* || true

            - name: Build the app
              run: |
                  if [ "${{ matrix.os }}" == "macos-intel" ]; then
                    npm run tauri build -- --target x86_64-apple-darwin
                  else
                    npm run tauri build
                  fi

            - name: Upload Windows artifacts
              if: matrix.os == 'windows'
              uses: actions/upload-artifact@v4
              with:
                  name: yt-dlp-gui-windows
                  path: |
                      src-tauri/target/${{ matrix.target }}/release/bundle/msi/*.msi
                      src-tauri/target/${{ matrix.target }}/release/bundle/nsis/*.exe
                  retention-days: 30

            - name: Upload macOS ARM64 artifacts
              if: matrix.os == 'macos'
              uses: actions/upload-artifact@v4
              with:
                  name: yt-dlp-gui-macos-arm64
                  path: |
                      src-tauri/target/${{ matrix.target }}/release/bundle/macos/*.app
                      src-tauri/target/${{ matrix.target }}/release/bundle/dmg/*.dmg
                  retention-days: 30

            - name: Upload macOS Intel artifacts
              if: matrix.os == 'macos-intel'
              uses: actions/upload-artifact@v4
              with:
                  name: yt-dlp-gui-macos-x86_64
                  path: |
                      src-tauri/target/${{ matrix.target }}/release/bundle/macos/*.app
                      src-tauri/target/${{ matrix.target }}/release/bundle/dmg/*.dmg
                  retention-days: 30

            - name: Upload Linux artifacts
              if: matrix.os == 'linux'
              uses: actions/upload-artifact@v4
              with:
                  name: yt-dlp-gui-linux
                  path: |
                      src-tauri/target/${{ matrix.target }}/release/bundle/appimage/*.AppImage
                      src-tauri/target/${{ matrix.target }}/release/bundle/deb/*.deb
                  retention-days: 30
